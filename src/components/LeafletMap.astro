---
import 'leaflet/dist/leaflet.css';
import { location, company } from '@/settings';

export interface Props {
  latitude?: number;
  longitude?: number;
  zoom?: number;
  tileLayer?: string;
  markerComponent?: string;
}

const {
  latitude = location.lat,
  longitude = location.lng,
  zoom = 13,
  tileLayer,
  markerComponent,
} = Astro.props;
---

<div class="map-container">
  <leaflet-map
    class="leaflet-map"
    data-latitude={latitude}
    data-longitude={longitude}
    data-zoom={zoom}
    data-tiles={tileLayer}
    data-marker-component={markerComponent ||
      `<div style="font-fUamily: var(--font-main); color: #000; padding: 4px;"><strong>${company}</strong><br>${location.city}</div>`}
  >
  </leaflet-map>
</div>

<script>
  import L, { type LatLngTuple } from 'leaflet';

  class LeafletMap extends HTMLElement {
    private map: L.Map | null = null;
    private tileLayer: L.TileLayer | null = null;

    connectedCallback() {
      const { latitude, longitude, zoom, markerComponent } = this.dataset;
      const latlng: LatLngTuple = [Number(latitude), Number(longitude)];

      this.map = L.map(this, {
        scrollWheelZoom: false,
        dragging: !L.Browser.mobile,
        attributionControl: false,
      }).setView(latlng, Number(zoom));

      // Enable interaction on click/tap
      this.map.once('click', () => {
        this.map?.scrollWheelZoom.enable();
        this.map?.dragging.enable();
      });

      this.updateTiles();

      // Custom marker icon
      const myIcon = L.divIcon({
        className: 'custom-marker',
        html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 text-primary"><path fill-rule="evenodd" d="M11.54 22.351l.07.04.028.016a.76.76 0 00.723 0l.028-.015.071-.041a16.975 16.975 0 001.144-.742 19.58 19.58 0 002.683-2.282c1.944-1.99 3.963-4.98 3.963-8.827a8.25 8.25 0 00-16.5 0c0 3.846 2.02 6.837 3.963 8.827a19.58 19.58 0 002.682 2.282 16.975 16.975 0 001.145.742zM12 13.5a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>`,
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40],
      });

      const marker = L.marker(latlng, { icon: myIcon }).addTo(this.map);

      if (markerComponent) {
        marker.bindPopup(markerComponent);
      }

      // Observer for theme changes
      const observer = new MutationObserver(() => {
        this.updateTiles();
      });

      observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['data-theme'],
      });
    }

    updateTiles() {
      if (!this.map) return;

      const isDark =
        document.documentElement.getAttribute('data-theme') === 'dark';

      // Remove existing layer
      if (this.tileLayer) {
        this.map.removeLayer(this.tileLayer);
      }

      const tileUrl = isDark
        ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
        : 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';

      this.tileLayer = L.tileLayer(tileUrl, {
        maxZoom: 19,
        subdomains: 'abcd',
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      }).addTo(this.map);
    }
  }

  window.customElements.define('leaflet-map', LeafletMap);
</script>

<style>
  .map-container {
    height: 100%;
    width: 100%;
    border-radius: 1.5rem;
    overflow: hidden;
    position: relative;
    box-shadow:
      0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06);
    border: 1px solid var(--color-border);
    background: var(--color-card-bg);
  }

  .leaflet-map {
    display: block;
    height: 100%;
    width: 100%;
    z-index: 1;
    min-height: 400px;
  }

  :global(.custom-marker) {
    color: var(--color-primary);
    filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));
  }

  :global(.leaflet-popup-content-wrapper) {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(8px);
    border-radius: 12px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  }

  :global(.leaflet-popup-tip) {
    background: rgba(255, 255, 255, 0.9);
  }
</style>
